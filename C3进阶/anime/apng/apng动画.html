<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>
  <body>
    <article>
      <section>
        APNGï¼ˆAnimated PNGï¼‰ç”± Mozilla äº 2004 å¹´æå‡ºï¼Œ æ–‡ä»¶æ‰©å±•åä»ç„¶æ˜¯
        .pngï¼Œä½†åŒ…å«å¤šä¸ª PNG å¸§ï¼Œç”¨æ¥å®ç°åŠ¨ç”»ã€‚ å®ƒå…¼å®¹æ€§è¾ƒå¥½â€”â€”æ™®é€šçš„ PNG
        è§£ç å™¨ä¼šåªæ˜¾ç¤ºç¬¬ä¸€å¸§ï¼Œ è€Œæ”¯æŒ APNG çš„æµè§ˆå™¨æˆ–å·¥å…·åˆ™å¯ä»¥æ’­æ”¾å®Œæ•´åŠ¨ç”»ã€‚

        æœ¬è´¨ä¼˜åŒ–: åˆ©ç”¨canvasæŠ€æœ¯, è®©å¤šå¼ apngèµ„æºåˆ‡æ¢æ—¶,å°½å¯èƒ½ç¼“å­˜æ•°æ®buffer.
        â€¢ âœ… é¦–æ¬¡æ’­æ”¾ï¼š æ­£å¸¸æ‰§è¡Œ + ç¼“å­˜æ„å»º
        â€¢ ğŸš€ é‡å¤æ’­æ”¾ï¼š å‡å°‘ 60-80% çš„ getImageData è°ƒç”¨
        â€¢ ğŸ§  å†…å­˜æ§åˆ¶ï¼š æ™ºèƒ½ LRU æ¸…ç†ï¼Œé™åˆ¶æ€»å†…å­˜ä½¿ç”¨
        â€¢ ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼š é’ˆå¯¹æ€§é™ä½ç¼“å­˜é˜ˆå€¼
      </section>
      <section>
        <!-- ç”Ÿæˆapngçš„æ–¹å¼ -->
        # å®‰è£… brew install apngasm
        <br>
        # ç”ŸæˆåŠ¨ç”» apngasm output.apng frame1.png frame2.png frame3.png
        <br>
        # ä½¿ç”¨ ffmpeg è§†é¢‘è½¬ä¸ºapng ffmpeg -i input.mp4 -plays 0 output.apng
      </section>
    </article>
    <img id="img" src="../apng/test.png" alt="Animated PNG">
    <div></div>
    <style>
      div {
        width: 100px;
        height: 100px;
        background-image: url("../apng/test.png");
      }
    </style>

    <canvas id="c"></canvas>
    <script type="module">
      import parseAPNG from "https://cdn.jsdelivr.net/npm/apng-js@1.1.5/+esm";

      /*
      ! æå‡apngçš„æ€§èƒ½, è¿˜æ˜¯è¦å€ŸåŠ©canvasçš„ä¸‰æ–¹åº“
      | åº“å              | ç‰¹ç‚¹                              | å®‰è£…æ–¹å¼                      |
| --------------- | ------------------------------- | ------------------------- |
| **apng-js**     | åŸç”Ÿ JS å®ç°ï¼Œæ— ä¾èµ–ï¼Œæ”¯æŒ Canvas æ¸²æŸ“ã€æš‚åœã€é‡æ’­ | `npm install apng-js`     |
| **apng-canvas** | ç®€åŒ–å°è£…ï¼Œè‡ªåŠ¨åŠ è½½ APNG åˆ° `<canvas>` æ’­æ”¾  | `npm install apng-canvas` |
| **upng-js**     | ä¸»è¦æ˜¯è§£ç  PNG/APNGï¼Œæ€§èƒ½å¾ˆé«˜ï¼Œå¯è‡ªå†™æ’­æ”¾å™¨é€»è¾‘    | `npm install upng-js`     |
| **pixi-apng**   | åŸºäº Pixi.jsï¼Œé€‚åˆæ¸¸æˆæˆ– UI åŠ¨ç”»          | `npm install pixi-apng`   |

      */
      /*
        console.log("parseAPNG", parseAPNG.default);
    */
      const canvas = document.getElementById("c");
      canvas.width = 640;
      canvas.height = 540;
      canvas.style = "zoom: 0.75";
      const ctx = canvas.getContext("2d");

      function getImgBuffer(url) {
        return new Promise(async (resolve) => {
          const blob = await fetch(url).then((res) => res.blob());
          const reader = new FileReader();
          reader.readAsArrayBuffer(blob);
          reader.onload = () => {
            resolve(reader.result);
          };
        });
      }

      async function createApngPlayer(url, options = {}) {
        const imgBuffer = await getImgBuffer(url);
        const apng = parseAPNG.default(imgBuffer);
        console.log(apng);
        Object.keys(options).forEach((key) => {
          apng[key] = options[key];
        });
        const player = await apng.getPlayer(ctx);
        return player;
      }

      (async () => {
        const player1 = await createApngPlayer("./test.png", {
          numPlays: 1,
        }); // è®¾ç½®å›¾1çš„ numPlays ä¸º1ï¼Œè®©å…¶åªæ’­æ”¾ä¸€æ¬¡
        const player2 = await createApngPlayer("./test.png");
        player1.play(); // å›¾1æ’­æ”¾
        player1.on("end", () => { // ç›‘å¬å›¾1çš„æ’­æ”¾ï¼Œå½“å…¶æ’­æ”¾å®Œæ¯•æ—¶ï¼Œé©¬ä¸Šå¼€å§‹å›¾2çš„æ’­æ”¾
          player2.play();
        });
        setTimeout(() => {
          player2.stop()
        }, 3000);
      })();
    </script>
  </body>
</html>
